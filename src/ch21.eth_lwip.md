# 单片机总结系列(19) ETH模块和TCP/IP通讯

ETH的配置和应用可以说是STM32中最复杂的应用, 从基础构建的话, 实现最基础的ping通讯都需要如下的功能实现.

1. ETH硬件驱动实现, 包含I/O的配置, ETH功能配置(DMA和中断使能, MAC设置)等
2. PHY芯片的初始化, 一般基于SMI接口, 进行寄存器配置
3. 协议栈的移植, 包含协议栈的配置和兼容层的实现, 如果在OS环境下, 还要完成OS的移植配置.

当完成上述三个步骤后, 才能实现协议栈支持的功能, 如ping, dhcp, socket等通讯功能, 而对于具体的网络应用, 还需要在此基础上去实现http, mqtt, telnet, snmp这些应用层协议实现, 网络应用可以说时单片机最复杂的应用之一, 远不是一篇文章能描述清楚的, 这里也只能抛砖引玉, 从应用的角度去整理和总结网络相关的知识, 更深入的学习还需要根据参考书籍进行学习.

通讯协议的学习其实一直是嵌入式应用中的难点, 即使开发出多种涉及网络的产品, 仍然不求甚解, 我也是在多年的不断的使用, 学习和整理后, 才有了一套自己的理解.通讯协议可以理解为约定不同设备进行交互的一套方法的总和, 虽然因为应用场景的不同, 有不同的层级和功能, 但最核心的都逃不掉如下的结构.

1. 物理层: 通讯之间物理硬件,例如通讯时有线还是无线, 通讯接口(RJ45, USB-TYPEC, COM), 工作电平、频段(2.4G), 信号的解析和生成方法, 这部分由芯片和器件的生产厂商实现, 如网络PHY, USB PHY, WIFI, 蓝牙芯片等, 对于使用者不用去关心具体的实现细节, 不过在器件选型, 硬件设计和布线时需要考虑辐射和干扰问题, 这部分经常被忽略, 但往往是产品设计稳定可靠的关键.
2. 协议层: 确定数据的格式, 如帧头, 数据长度, 协议版本信息, 数据包格式, 校验等, 基于协议层, 可以将两个设备建立逻辑上的连接, 从而在多设备互联的情况下实现一对一或多对多的通讯, 对于复杂的通讯协议, 往往在进一步分解成多层协议格式来应对不同的应用场景.
3. 应用层: 用于定义具体功能需求的应用功能, 这部分往往协议中只会定义大体的框架结构, 由设计者根据产品的需求进行填充来实现具体的应用.

将这种建立的体系进行TCP/IP的理解, 数据链路层对应的就是物理层, 定义了物理接口, 线缆, 电平, 数据格式, 冲突处理等.网络层和传输层就对应协议层, 网络层提供路由, 寻址功能, 保证对端的可达性；传输层提供端对端的通讯连接, 其中TCP是可靠连接, UDP则是不可靠的连接.应用层则是在传输层基础上定义基于应用的框架结构, 开发者通过实现应用层从而完成具体功能的实现, 讲解到这里, 

## 下一章节

[返回目录](./../README.md)

直接开始下一小节: [ch20.算法应用](./ch20.algorithm.md)
